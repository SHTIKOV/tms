<script>
        const DESCRIPTION_LENGTH = 110;
        const TASK_STATUS_LIST = ['planned', 'work', 'closed'];
        const TASK_STATUS_COLOR_LIST = {
            work:    '#dc3545', 
            closed:  '#28a745',
            planned: '#007bff'
        };
        
        function Task (data = {}) {
            let self = this,
                def = {{ defaultTask | json_encode | raw }};

            ko.mapping.fromJS ($.extend (def, data), {
                username: {
                    create: opts => {
                        return ko.observable (opts.data).extend ({
                            required: {
                                message: 'Please supply user name.'
                            }
                        });
                    }
                },
                description: {
                    create: opts => {
                        return ko.observable (opts.data).extend ({
                            required: {
                                message: 'Please supply task description.'
                            }
                        });
                    }
                },
                email: {
                    create: opts => {
                        return ko.observable (opts.data).extend ({
                            email: true,
                            required: {
                                message: 'Please supply email address.'
                            }
                        });
                    }
                },
            }, self);

            self.createdDate = moment.unix (self.created ()).format ('MMMM Do YYYY, h:mm:ss a');

            self.errors = ko.validation.group (self);

            self.shortDescription = ko.pureComputed ({
                read: () => {
                    let desc = self.description ();
                    return desc.length > DESCRIPTION_LENGTH 
                        ? desc.slice (0, DESCRIPTION_LENGTH-3) + '...' 
                        : desc
                },
                owner: self
            });

            self.showDescription = function () {
                viewModel.editModel.show ({
                    title: `Description task: ${self.id ()}`,
                    template: 'task-show-description-modal',
                    data: self,
                    hideSaveBtn: true,
                    isLg: true,
                });
            }

            {% if isAuth() %}
            self.edit = function () {
                viewModel.editModel.show ({
                    title: `Edit task: ${self.id ()}`,
                    template: 'task-edit-modal',
                    onSave: self.save,
                    onValidate: self.validate,
                    data: self,
                });
            }

            self.remove = function () {
                let n = noty (
                    'Are you sure wanna remove this task?', 
                    'warning', 
                    [
                        Noty.button ('Yes', 'btn btn-danger', function () {

                            $.ajax ({
                                type:   "GET",
                                url:    "/tasks/remove",
                                cache:  false,
                                data:   {id: self.id ()},
                                success: function () {
                                    noty ('Task removed', 'success');
                                    viewModel.tasks.remove (self);
                                    n.close ();
                                },
                                error: function (xhr, ajaxOptions, thrownError) {
                                    noty (thrownError, "error");
                                }
                            });
                        }, {id: 'yes', 'data-status': 'ok'})
                    ],
                    false
                );
            }
            {% endif %}

            self.save = function () {
                $.ajax ({
                    type:   "GET",
                    url:    "/tasks/edit",
                    cache:  false,
                    data:   ko.mapping.toJS (self),
                    success: function (task) {
                        task = JSON.parse (String (task));
                        if (!self.id ()) {
                            self.id (task.id);
                            self.isEdited (task.isEdited);
                            viewModel.tasks.push (self);
                        }
                        noty ('Task saved', 'success');
                        viewModel.table.load ();
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        noty ("Can't save task", "error");
                    }
                });
            }

            self.validate = function () {
                if (self.errors ().length > 0) {
                    noty ('Check that the form is filled in correctly', 'warning');
                    return false;
                }

                return true;
            }
        }

        function ViewModel () {
            let self = this;

            self.editModel = new ModalEditor ();
            self.table = new Table ({
                head: [
                    {name: '#',           field: 'id',          sort: true, width: '50px'},
                    {name: 'Name',        field: 'name',        sort: true},
                    {name: 'Email',       field: 'email',       sort: true},
                    {name: 'Description', field: 'description', sort: true},
                    {name: 'Status',      field: '',            sort: false},
                    {name: 'Created',     field: 'created',     sort: true, width: '150px'},
                    {name: 'Action',      field: '',            sort: false, align: 'right', width: '200px'},
                ],
                loadUrl: '/tasks/load'
            }, {
                addMethod: function () {
                    let task = new Task ();
                    self.editModel.show ({
                        title: 'Add new task',
                        template: 'task-edit-modal',
                        onSave: task.save,
                        data: task,
                        onValidate: task.validate,
                    });
                },
                onLoad: function (response) {
                    if (response == undefined) {
                        return;
                    }
                    
                    let tasks = JSON.parse (response);
                    
                    viewModel.table.data (tasks.map (task => new Task (task)));
                }
            });
        }

        var viewModel = new ViewModel ();
        ko.applyBindings (viewModel, $("body")[0]);
    </script>